<!-- sldsValidatorIgnore -->
<!--
  Ontario Design System - Lookup for OmniStudio
  
  Provides a searchable dropdown with autocomplete functionality.
  
  Compliance:
  - LWR: Compatible (Light DOM pattern)
  - LWS: Compatible (no restricted APIs)
  - Ontario DS: Uses Ontario form field styling
  - WCAG 2.1 AA: 
    - Proper ARIA combobox pattern
    - aria-expanded, aria-controls, aria-activedescendant
    - Keyboard navigation (up/down arrows, enter, escape)
    - Screen reader announcements
-->
<template>
  <div class="ontario-form-group sfgpsdscaon-lookup">
    <!-- Label -->
    <div data-label="true">
      <label
        class={computedLabelClassName}
        aria-label={mergedLabel}
        for="lookupId"
      >
        {mergedLabel}
        <span lwc:if={showFlag} class="ontario-label__flag">({flagText})</span>
        <span lwc:if={_propSetMap.required} class="ontario-show-for-sr">
          ({allCustomLabelsUtil.OmniRequired})
        </span>
      </label>
    </div>

    <!-- Hint text -->
    <p lwc:if={mergedHelpText} id="helper" class="ontario-hint">
      {mergedHelpText}
    </p>

    <!-- Screen reader announcements for results (AODA) -->
    <div
      class="ontario-show-for-sr"
      aria-live="polite"
      aria-atomic="true"
      role="status"
    >
      <span lwc:if={show}>{resultsAnnouncement}</span>
    </div>

    <!-- Combobox container -->
    <div class="sfgpsdscaon-combobox-container">
      <div class="sfgpsdscaon-combobox">
        <div class="sfgpsdscaon-combobox__form-element" role="none">
          <!-- Input field -->
          <!-- AODA: Added aria-required for screen reader announcement -->
          <input
            class={computedInputClassName}
            type="text"
            disabled={_propSetMap.readOnly}
            required={_propSetMap.required}
            aria-required={_propSetMap.required}
            readonly={_propSetMap.readOnly}
            aria-controls="lookup"
            id="lookupId"
            placeholder={mergedPlaceholder}
            aria-invalid={sfGpsDsIsError}
            aria-expanded={show}
            aria-haspopup="listbox"
            value={lookupDisplay}
            aria-describedby={computedAriaDescribedBy}
            role="combobox"
            autocomplete="off"
            data-omni-input
            onblur={hideOptions}
            onkeydown={handleKeyDown}
            onkeyup={handleKeyUp}
            onmouseup={showLookup}
          />

          <!-- Loading indicator (inline) -->
          <template lwc:if={isPageLoading}>
            <div class="sfgpsdscaon-combobox__loader">
              <div
                class="ontario-loading-indicator ontario-loading-indicator--small"
                role="alert"
                aria-live="assertive"
                aria-busy="true"
              >
                <svg
                  class="ontario-loading-indicator__spinner"
                  viewBox="25 25 50 50"
                  aria-hidden="true"
                  focusable="false"
                >
                  <circle cx="50" cy="50" r="20" fill="none" stroke-width="4" />
                </svg>
              </div>
            </div>
          </template>

          <!-- Dropdown arrow -->
          <svg
            class="sfgpsdscaon-combobox__icon"
            aria-hidden="true"
            focusable="false"
            viewBox="0 0 24 24"
          >
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
          </svg>
        </div>

        <!-- Dropdown list -->
        <div
          class={computedDropdownClassName}
          id="lookup"
          role="listbox"
          onmousedown={handleKeyDown}
          onmouseleave={handleKeyDown}
          onmouseup={handleKeyDown}
        >
          <ul class="sfgpsdscaon-listbox" role="presentation">
            <template
              for:each={computedOptions}
              for:item="optionItem"
              for:index="optionIndex"
            >
              <li
                key={optionItem.key}
                class="sfgpsdscaon-listbox__item"
                role="presentation"
                data-option-index={optionIndex}
                onmouseup={selectOption}
                onmouseover={mouseOverFocus}
              >
                <div
                  lwc:if={optionItem.isClear}
                  class="sfgpsdscaon-listbox__option sfgpsdscaon-listbox__option--clear"
                  id={optionItem.id}
                  role="option"
                  aria-selected={optionItem.selected}
                >
                  <span
                    class="sfgpsdscaon-listbox__option-text"
                    title={optionItem.value}
                  >
                    {optionItem.value}
                  </span>
                </div>

                <a
                  lwc:else
                  href={optionItem.href}
                  class="sfgpsdscaon-listbox__option"
                  id={optionItem.id}
                  role="option"
                  aria-selected={optionItem.selected}
                >
                  {optionItem.value}
                </a>
              </li>
            </template>
          </ul>
        </div>
      </div>
    </div>

    <!-- Error message -->
    <div
      lwc:if={sfGpsDsIsError}
      class="ontario-error-messaging"
      aria-live="assertive"
      role="alert"
      id="errorMessageBlock"
    >
      <svg
        class="ontario-icon"
        aria-hidden="true"
        focusable="false"
        viewBox="0 0 24 24"
      >
        <path
          d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
        />
      </svg>
      <span class="ontario-error-messaging__content"
        >{sfGpsDsErrorMessage}</span
      >
    </div>
  </div>
</template>
