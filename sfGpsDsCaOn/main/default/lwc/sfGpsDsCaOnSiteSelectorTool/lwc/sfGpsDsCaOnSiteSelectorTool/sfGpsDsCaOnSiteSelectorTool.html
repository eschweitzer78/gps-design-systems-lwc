<template lwc:render-mode="light">
  <div class={computedContainerClassName}>
    <!-- Trigger Button -->
    <button
      type="button"
      class={triggerButtonClassName}
      onclick={handleOpenClick}
    >
      <svg
        class="sfgpsdscaon-site-selector__trigger-icon"
        viewBox="0 0 24 24"
        aria-hidden="true"
        focusable="false"
      >
        <path
          d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"
          fill="currentColor"
        />
      </svg>
      {computedButtonLabel}
    </button>

    <!-- Modal -->
    <c-sf-gps-ds-ca-on-modal
      title={computedModalTitle}
      size="full"
      is-open={isModalOpen}
      hide-footer="true"
      onclose={handleModalClose}
    >
      <div slot="content" class="sfgpsdscaon-site-selector__content">
        <!-- Two Panel Layout -->
        <div class="sfgpsdscaon-site-selector__panels">
          <!-- Left Panel - Controls -->
          <div class="sfgpsdscaon-site-selector__left-panel">
            <!-- Search Controls (hidden in read-only mode) -->
            <template lwc:if={showSearchControls}>
              <!-- Search Parameter Dropdown -->
              <div class="sfgpsdscaon-site-selector__field">
                <label
                  for="search-parameter"
                  class="ontario-label sfgpsdscaon-site-selector__label"
                >
                  Search by other parameters
                </label>
                <select
                  id="search-parameter"
                  class="ontario-input sfgpsdscaon-site-selector__select"
                  onchange={handleSearchParameterChange}
                >
                  <template for:each={searchParameterOptions} for:item="opt">
                    <option
                      key={opt.value}
                      value={opt.value}
                      selected={opt.selected}
                    >
                      {opt.label}
                    </option>
                  </template>
                </select>
              </div>

              <!-- Address Search -->
              <div class="sfgpsdscaon-site-selector__field">
                <label
                  for="address-search"
                  class="ontario-label sfgpsdscaon-site-selector__label"
                >
                  Enter address
                  <span class="ontario-label__flag">(required)</span>
                </label>
                <p class="ontario-hint" id="address-hint">
                  {searchPlaceholder}
                </p>
                <div class="sfgpsdscaon-site-selector__search-row">
                  <div class="sfgpsdscaon-site-selector__search-input-wrapper">
                    <input
                      id="address-search"
                      type="text"
                      class="ontario-input sfgpsdscaon-site-selector__search-input"
                      value={_searchValue}
                      aria-describedby="address-hint"
                      oninput={handleSearchInputChange}
                      onkeydown={handleSearchKeyDown}
                    />
                    <button
                      lwc:if={_searchValue}
                      type="button"
                      class="sfgpsdscaon-site-selector__clear-btn"
                      aria-label="Clear search"
                      onclick={handleClearSearch}
                    >
                      <svg
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                        focusable="false"
                      >
                        <path
                          d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                          fill="currentColor"
                        />
                      </svg>
                    </button>
                  </div>
                  <button
                    type="button"
                    class="ontario-button ontario-button--primary sfgpsdscaon-site-selector__search-btn"
                    onclick={handleSearchClick}
                    disabled={_isSearching}
                  >
                    <svg
                      viewBox="0 0 24 24"
                      aria-hidden="true"
                      focusable="false"
                    >
                      <path
                        d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                        fill="currentColor"
                      />
                    </svg>
                    <span class="ontario-show-for-sr">Search</span>
                  </button>
                </div>
              </div>

              <!-- Error Message -->
              <div
                lwc:if={_errorMessage}
                class="sfgpsdscaon-site-selector__error"
                role="alert"
              >
                {_errorMessage}
              </div>
            </template>

            <!-- Read-only mode header -->
            <template lwc:if={isReadOnly}>
              <div class="sfgpsdscaon-site-selector__readonly-header">
                <h3 class="sfgpsdscaon-site-selector__readonly-title">
                  Submitted Location
                </h3>
                <p class="sfgpsdscaon-site-selector__readonly-hint">
                  This location was captured during the application submission.
                </p>
              </div>
            </template>

            <!-- Address Details (shown when address is found) -->
            <div
              lwc:if={hasAddressDetails}
              class="sfgpsdscaon-site-selector__address-details"
              role="region"
              aria-live="polite"
              aria-label="Selected address"
            >
              <h3 class="sfgpsdscaon-site-selector__details-heading">
                Site location details
              </h3>
              <p class="sfgpsdscaon-site-selector__address-line">
                {streetAddress}
              </p>
              <p class="sfgpsdscaon-site-selector__address-line">
                {cityProvincePostal}
              </p>
              <p class="sfgpsdscaon-site-selector__address-line">{country}</p>
            </div>

            <!-- Screen reader announcement for address updates -->
            <div
              class="ontario-show-for-sr"
              aria-live="assertive"
              aria-atomic="true"
            >
              {addressAnnouncementText}
            </div>

            <!-- Instructions (only in edit mode) -->
            <p
              lwc:if={showSaveButton}
              class="sfgpsdscaon-site-selector__instructions"
            >
              Once you have finalized the site location, select
              <strong>"Save site address"</strong>.
            </p>

            <!-- Save Button (only in edit mode) -->
            <button
              lwc:if={showSaveButton}
              type="button"
              class="ontario-button ontario-button--primary sfgpsdscaon-site-selector__save-btn"
              onclick={handleSaveClick}
              disabled={isSaveDisabled}
            >
              Save site address
            </button>

            <!-- Close Button (in read-only mode) -->
            <button
              lwc:if={isReadOnly}
              type="button"
              class="ontario-button ontario-button--secondary sfgpsdscaon-site-selector__close-btn"
              onclick={handleModalClose}
            >
              Close
            </button>

            <!-- Tab Bar -->
            <div
              class="sfgpsdscaon-site-selector__tabs"
              role="tablist"
              aria-label="Map view options"
              onkeydown={handleTabKeyDown}
            >
              <button
                type="button"
                role="tab"
                id="tab-search"
                class={searchTabClassName}
                aria-selected={isSearchTabActive}
                tabindex={searchTabTabIndex}
                data-tab="search"
                onclick={handleTabClick}
              >
                <svg
                  class="sfgpsdscaon-site-selector__tab-icon"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                  focusable="false"
                >
                  <path
                    d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                    fill="currentColor"
                  />
                </svg>
                Search
              </button>
              <button
                type="button"
                role="tab"
                id="tab-sitepoint"
                class={sitePointTabClassName}
                aria-selected={isSitePointTabActive}
                tabindex={sitePointTabTabIndex}
                data-tab="sitepoint"
                onclick={handleTabClick}
              >
                <svg
                  class="sfgpsdscaon-site-selector__tab-icon"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                  focusable="false"
                >
                  <path
                    d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"
                    fill="currentColor"
                  />
                </svg>
                Site point
              </button>
              <button
                type="button"
                role="tab"
                id="tab-layers"
                class={layersTabClassName}
                aria-selected={isLayersTabActive}
                tabindex={layersTabTabIndex}
                data-tab="layers"
                onclick={handleTabClick}
              >
                <svg
                  class="sfgpsdscaon-site-selector__tab-icon"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                  focusable="false"
                >
                  <path
                    d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"
                    fill="currentColor"
                  />
                </svg>
                Layers
              </button>
            </div>
          </div>

          <!-- Right Panel - Map -->
          <div class="sfgpsdscaon-site-selector__right-panel">
            <iframe
              lwc:if={hasVfPageUrl}
              class="sfgpsdscaon-site-selector__map-iframe"
              src={computedVfPageUrl}
              title="ESRI Map - Site Selection"
            ></iframe>
            <div
              lwc:if={hasNoVfPageUrl}
              class="sfgpsdscaon-site-selector__map-placeholder"
            >
              <p>Map loading...</p>
            </div>
          </div>
        </div>
      </div>
    </c-sf-gps-ds-ca-on-modal>
  </div>
</template>
