<apex:page
  lightningStylesheets="true"
  controller="SfGpsDsCaOnSiteSelectorCtr"
  docType="html-5.0"
  showHeader="false"
  sidebar="false"
>
  <!--
    * Copyright (c) 2026, Shannon Schupbach, salesforce.com, inc.
    * All rights reserved.
    * Licensed under the BSD 3-Clause license.
    *
    * ESRI Site Selector Map Page
    * Provides address geocoding and site point selection for Ontario Design System.
    * LWR/LWS compatible via postMessage communication.
    -->
  <html>
    <head>
      <meta charset="utf-8" />
      <meta
        name="viewport"
        content="initial-scale=1,maximum-scale=1,user-scalable=no"
      />
      <title>Site Selector Map</title>
      <style>
        html,
        body {
          padding: 0;
          margin: 0;
          height: 100%;
          width: 100%;
        }
        .mapContainer {
          height: 100%;
          width: 100%;
        }
        .loadingIcon {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 100;
        }
      </style>
      <!-- ESRI ArcGIS JavaScript SDK v4.29 loaded from CDN -->
      <link
        rel="stylesheet"
        href="https://js.arcgis.com/4.29/esri/themes/light/main.css"
      />
      <script src="https://js.arcgis.com/4.29/"></script>
    </head>
    <body>
      <div class="loadingIcon" id="loadingIcon">
        <span id="loadingText">Loading map...</span>
      </div>
      <div id="viewDiv" class="mapContainer"></div>

      <script>
        // Configuration from Apex controller
        var apiKey = "{!JSENCODE(apiKey)}";
        var defaultLat = parseFloat("{!JSENCODE(defaultLatitude)}") || 43.6532;
        var defaultLng =
          parseFloat("{!JSENCODE(defaultLongitude)}") || -79.3832;
        var communityUrl = "{!JSENCODE(communityUrl)}";

        // Parse mode from URL parameter (defaults to "search")
        var urlParams = new URLSearchParams(window.location.search);
        var initialMode = urlParams.get("mode") || "search";
        // Validate mode value
        // "discharge" is used by DischargePointSelector, behaves like "search"
        var validModes = [
          "search",
          "sitepoint",
          "layers",
          "readonly",
          "discharge"
        ];
        var currentMode = validModes.includes(initialMode)
          ? initialMode
          : "search";
        console.log(
          "VF Page - Initial mode from URL:",
          initialMode,
          "-> currentMode:",
          currentMode
        );

        var currentMarker = null;
        var graphicsLayer = null;
        var view = null;
        var search = null;

        // Ontario LIO Services base URLs
        var LIO_BASE_URL =
          "https://ws.lioservices.lrc.gov.on.ca/arcgis2/rest/services";
        var ACCESS_ENV_URL =
          LIO_BASE_URL + "/Access_Environment/Access_Environment_Map/MapServer";
        var MECP_BOUNDARIES_URL =
          LIO_BASE_URL + "/MOE/MECP_Full_Boundaries/MapServer";

        // Reference to MECP district layer for queries
        var mecpDistrictLayer = null;

        // Initialize ESRI map
        require([
          "esri/config",
          "esri/Map",
          "esri/views/MapView",
          "esri/widgets/ScaleBar",
          "esri/widgets/Search",
          "esri/widgets/Locate",
          "esri/widgets/LayerList",
          "esri/widgets/Expand",
          "esri/widgets/Legend",
          "esri/Graphic",
          "esri/layers/GraphicsLayer",
          "esri/layers/MapImageLayer",
          "esri/layers/FeatureLayer",
          "esri/geometry/Point",
          "esri/rest/query",
          "esri/rest/support/Query"
        ], function (
          esriConfig,
          Map,
          MapView,
          ScaleBar,
          Search,
          Locate,
          LayerList,
          Expand,
          Legend,
          Graphic,
          GraphicsLayer,
          MapImageLayer,
          FeatureLayer,
          Point,
          query,
          Query
        ) {
          // Configure ESRI API key
          if (apiKey) {
            esriConfig.apiKey = apiKey;
          }

          // Create map
          var map = new Map({
            basemap: "topo-vector" // Topographic basemap
          });

          // ========================================
          // ONTARIO LIO LAYERS
          // ========================================

          // MECP District Boundaries Layer (for district office lookup)
          mecpDistrictLayer = new FeatureLayer({
            url: MECP_BOUNDARIES_URL + "/0",
            title: "MECP District Boundaries",
            visible: false,
            opacity: 0.5,
            outFields: ["*"],
            popupTemplate: {
              title: "{DISTRICT_N}",
              content: [
                {
                  type: "fields",
                  fieldInfos: [
                    { fieldName: "DISTRICT_N", label: "District Name" },
                    { fieldName: "AREA_OFFIC", label: "Area Office" },
                    { fieldName: "PHONE", label: "Phone" }
                  ]
                }
              ]
            }
          });
          map.add(mecpDistrictLayer);

          // Access Environment Layer - Environmental Registrations
          var accessEnvLayer = new MapImageLayer({
            url: ACCESS_ENV_URL,
            title: "Ontario Environment Data",
            visible: false,
            opacity: 0.8,
            sublayers: [
              {
                id: 3,
                title: "EASR Registrations",
                visible: true,
                popupEnabled: true
              },
              {
                id: 1,
                title: "Environmental Compliance Approvals",
                visible: false
              },
              {
                id: 5,
                title: "Permit to Take Water",
                visible: false
              },
              {
                id: 6,
                title: "Record of Site Condition",
                visible: false
              }
            ]
          });
          map.add(accessEnvLayer);

          // Create map view
          view = new MapView({
            container: "viewDiv",
            map: map,
            center: [defaultLng, defaultLat],
            zoom: 12,
            constraints: {
              rotationEnabled: false,
              minZoom: 5
            }
          });

          // Graphics layer for markers (added last to be on top)
          graphicsLayer = new GraphicsLayer({
            title: "Selected Location"
          });
          map.add(graphicsLayer);

          // Add scale bar
          var scalebar = new ScaleBar({
            view: view,
            unit: "metric"
          });
          view.ui.add(scalebar, "bottom-right");

          // Add Search widget (geocoding)
          search = new Search({
            view: view,
            includeDefaultSources: true,
            popupEnabled: false, // We handle results ourselves
            resultGraphicEnabled: false // We add our own marker
          });
          view.ui.add(search, "top-right");

          // Handle search complete
          search.on("search-complete", function (event) {
            console.log("VF Page - Search complete event:", event);
            console.log(
              "VF Page - Results count:",
              event.results?.length,
              event.results?.[0]?.results?.length
            );
            if (
              event.results &&
              event.results.length > 0 &&
              event.results[0].results &&
              event.results[0].results.length > 0
            ) {
              var result = event.results[0].results[0];
              console.log("VF Page - Found result:", result);
              handleSearchResult(result);
            } else {
              console.log("VF Page - No results found");
              sendToLWC({
                name: "searchResult",
                error: "No results found for this address"
              });
            }
          });

          // Add Locate widget
          var locate = new Locate({
            view: view
          });
          view.ui.add(locate, "top-left");

          // Add Layer List in expandable panel
          var layerList = new LayerList({
            view: view,
            listItemCreatedFunction: function (event) {
              var item = event.item;
              // Add legend for each layer
              if (item.layer.type !== "graphics") {
                item.panel = {
                  content: "legend",
                  open: false
                };
              }
            }
          });
          var layerExpand = new Expand({
            view: view,
            content: layerList,
            expanded: false,
            expandIconClass: "esri-icon-layers",
            expandTooltip: "Ontario Data Layers"
          });
          view.ui.add(layerExpand, "top-left");

          // Add Legend widget
          var legend = new Legend({
            view: view,
            style: "card"
          });
          var legendExpand = new Expand({
            view: view,
            content: legend,
            expanded: false,
            expandIconClass: "esri-icon-legend",
            expandTooltip: "Legend"
          });
          view.ui.add(legendExpand, "bottom-left");

          // Handle map click for site point mode
          view.on("click", function (event) {
            if (currentMode === "sitepoint") {
              placeMarker(event.mapPoint);
              reverseGeocode(event.mapPoint);
            }
          });

          // Hide loading when view is ready
          view.when(function () {
            document.getElementById("loadingIcon").style.display = "none";

            // Apply initial mode from URL parameter
            console.log(
              "VF Page - Map ready, applying initial mode:",
              currentMode
            );
            applyMode(currentMode);

            sendToLWC({ name: "pageLoaded", currentMode: currentMode });
          });

          /**
           * Handles search result and places marker
           */
          function handleSearchResult(result) {
            var feature = result.feature;
            var geometry = feature.geometry;

            // Place marker
            placeMarker(geometry);

            // Parse address from result
            var address = parseAddress(result);

            // Send to LWC
            sendToLWC({
              name: "searchResult",
              address: address,
              coordinates: {
                latitude: geometry.latitude,
                longitude: geometry.longitude
              }
            });

            // Zoom to result
            view.goTo({
              target: geometry,
              zoom: 17
            });

            // Query MECP district for this location
            var point = new Point({
              latitude: geometry.latitude,
              longitude: geometry.longitude
            });
            queryMECPDistrict(point);
          }

          /**
           * Places a marker on the map
           */
          function placeMarker(point) {
            // Clear existing marker
            graphicsLayer.removeAll();

            // Create marker symbol
            var markerSymbol = {
              type: "simple-marker",
              color: "#cd0000", // Ontario red
              size: "16px",
              outline: {
                color: "#ffffff",
                width: 2
              }
            };

            // Create graphic
            var pointGraphic = new Graphic({
              geometry: point,
              symbol: markerSymbol
            });

            graphicsLayer.add(pointGraphic);
            currentMarker = pointGraphic;
          }

          /**
           * Performs reverse geocoding on a point
           */
          function reverseGeocode(point) {
            // Use ESRI locator for reverse geocoding
            require(["esri/rest/locator"], function (locator) {
              var locatorUrl =
                "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer";

              locator
                .locationToAddress(locatorUrl, {
                  location: point
                })
                .then(function (response) {
                  var address = {
                    streetAddress: response.address || "",
                    city: response.attributes?.City || "",
                    province: response.attributes?.Region || "",
                    postalCode: response.attributes?.Postal || "",
                    country: response.attributes?.CountryCode || "Canada",
                    fullAddress: response.address || ""
                  };

                  sendToLWC({
                    name: "pinPlaced",
                    address: address,
                    coordinates: {
                      latitude: point.latitude,
                      longitude: point.longitude
                    }
                  });

                  // Also query MECP district for this location
                  queryMECPDistrict(point);
                })
                .catch(function (error) {
                  sendToLWC({
                    name: "error",
                    error: "Could not determine address for this location"
                  });
                });
            });
          }

          /**
           * Queries the MECP District boundary layer to find which district contains the point
           */
          function queryMECPDistrict(point) {
            if (!mecpDistrictLayer) {
              return;
            }

            var districtQuery = new Query();
            districtQuery.geometry = point;
            districtQuery.spatialRelationship = "intersects";
            districtQuery.outFields = ["*"];
            districtQuery.returnGeometry = false;

            query
              .executeQueryJSON(MECP_BOUNDARIES_URL + "/0/query", districtQuery)
              .then(function (results) {
                if (results.features && results.features.length > 0) {
                  var attrs = results.features[0].attributes;

                  // Build MECP district info object
                  var mecpDistrict = {
                    districtName: attrs.DISTRICT_N || attrs.DISTRICT_NAME || "",
                    areaOffice: attrs.AREA_OFFIC || attrs.AREA_OFFICE || "",
                    phone: attrs.PHONE || "",
                    tollFree: attrs.TOLL_FREE || "",
                    address: attrs.ADDRESS || "",
                    city: attrs.CITY || "",
                    postalCode: attrs.POSTAL_CODE || ""
                  };

                  // Format full address if components exist
                  if (mecpDistrict.address && mecpDistrict.city) {
                    mecpDistrict.fullAddress =
                      mecpDistrict.address +
                      ", " +
                      mecpDistrict.city +
                      ", ON " +
                      mecpDistrict.postalCode;
                  }

                  sendToLWC({
                    name: "mecpDistrictFound",
                    mecpDistrict: mecpDistrict
                  });
                } else {
                  sendToLWC({
                    name: "mecpDistrictFound",
                    mecpDistrict: null,
                    message: "Location is outside Ontario MECP districts"
                  });
                }
              })
              .catch(function (error) {
                console.warn("MECP District query failed:", error);
                // Don't send error to LWC - this is optional data
              });
          }

          /**
           * Toggles visibility of Ontario LIO layers
           */
          function toggleOntarioLayers(visible) {
            if (mecpDistrictLayer) {
              mecpDistrictLayer.visible = visible;
            }
            // Find and toggle Access Environment layer
            map.layers.forEach(function (layer) {
              if (layer.title === "Ontario Environment Data") {
                layer.visible = visible;
              }
            });
          }

          /**
           * Parses address from search result
           */
          function parseAddress(result) {
            var attrs = result.feature.attributes || {};
            var name = result.name || "";

            // Try to parse from attributes
            var address = {
              streetAddress:
                attrs.StAddr || attrs.Address || attrs.Match_addr || "",
              city: attrs.City || attrs.PlaceName || "",
              province: attrs.Region || attrs.RegionAbbr || "ON",
              postalCode: attrs.Postal || "",
              country: attrs.Country || attrs.CntryName || "Canada",
              fullAddress: name
            };

            // If no street address, use the full name
            if (!address.streetAddress && name) {
              var parts = name.split(",");
              if (parts.length > 0) {
                address.streetAddress = parts[0].trim();
              }
            }

            return address;
          }

          /**
           * Clears the current marker
           */
          function clearMarker() {
            graphicsLayer.removeAll();
            currentMarker = null;
          }

          /**
           * Applies mode settings to the map UI
           * Called both on initial load (from URL param) and on modeChange messages
           */
          function applyMode(mode) {
            console.log("VF Page - applyMode called with:", mode);
            currentMode = mode;

            // Update UI based on mode
            if (mode === "search" || mode === "discharge") {
              // "discharge" mode (used by DischargePointSelector) behaves like "search"
              console.log(
                "VF Page - Setting search/discharge mode: cursor=default, search=visible"
              );
              search.visible = true;
              view.cursor = "default";
            } else if (mode === "sitepoint") {
              console.log(
                "VF Page - Setting sitepoint mode: cursor=crosshair, search=hidden"
              );
              search.visible = false;
              view.cursor = "crosshair";
            } else if (mode === "layers") {
              console.log(
                "VF Page - Setting layers mode: cursor=default, search=visible"
              );
              search.visible = true;
              view.cursor = "default";
            } else if (mode === "readonly") {
              console.log(
                "VF Page - Setting readonly mode: cursor=default, search=hidden"
              );
              // Read-only mode: hide search, disable map click
              search.visible = false;
              view.cursor = "default";
              // Expand the layer list for review
              if (layerExpand) {
                layerExpand.expanded = true;
              }
            }
          }

          /**
           * Sends message to parent LWC
           */
          function sendToLWC(data) {
            console.log("VF Page - sendToLWC:", {
              data: data,
              communityUrl: communityUrl,
              targetOrigin: communityUrl || "*"
            });
            if (communityUrl) {
              parent.postMessage(data, communityUrl);
            } else {
              // Fallback for development
              parent.postMessage(data, "*");
            }
            console.log("VF Page - Message posted to parent");
          }

          /**
           * Handles messages from parent LWC
           */
          window.addEventListener("message", function (event) {
            console.log("VF Page - Received message:", {
              origin: event.origin,
              communityUrl: communityUrl,
              data: event.data,
              dataType: typeof event.data
            });

            // Validate origin if communityUrl is set
            if (communityUrl && event.origin !== communityUrl) {
              console.warn("VF Page - Message rejected, origin mismatch:", {
                eventOrigin: event.origin,
                expectedOrigin: communityUrl
              });
              return;
            }

            try {
              var msg =
                typeof event.data === "string"
                  ? JSON.parse(event.data)
                  : event.data;

              console.log("VF Page - Parsed message:", msg);

              switch (msg.title) {
                case "search":
                  console.log("VF Page - Processing search:", msg.detail);
                  if (msg.detail && msg.detail.query) {
                    console.log(
                      "VF Page - Calling ESRI search with query:",
                      msg.detail.query
                    );
                    search.search(msg.detail.query);
                  }
                  break;

                case "clearMarker":
                  clearMarker();
                  break;

                case "modeChange":
                  console.log("VF Page - modeChange received:", msg.detail);
                  if (msg.detail && msg.detail.mode) {
                    applyMode(msg.detail.mode);
                  }
                  break;

                case "goTo":
                  if (
                    msg.detail &&
                    msg.detail.latitude &&
                    msg.detail.longitude
                  ) {
                    var point = new Point({
                      latitude: msg.detail.latitude,
                      longitude: msg.detail.longitude
                    });
                    view
                      .goTo({
                        target: point,
                        zoom: msg.detail.zoom || 17
                      })
                      .then(function () {
                        // Place marker if requested
                        if (msg.detail.placeMarker) {
                          placeMarker(point);
                          reverseGeocode(point);
                        }
                      });
                  }
                  break;

                case "toggleOntarioLayers":
                  // Toggle visibility of Ontario LIO layers
                  if (msg.detail && typeof msg.detail.visible !== "undefined") {
                    toggleOntarioLayers(msg.detail.visible);
                  }
                  break;

                case "showMECPDistricts":
                  // Toggle MECP district boundaries visibility
                  if (mecpDistrictLayer) {
                    mecpDistrictLayer.visible = msg.detail?.visible !== false;
                  }
                  break;

                case "queryMECPDistrict":
                  // Query MECP district for specific coordinates
                  if (
                    msg.detail &&
                    msg.detail.latitude &&
                    msg.detail.longitude
                  ) {
                    var queryPoint = new Point({
                      latitude: msg.detail.latitude,
                      longitude: msg.detail.longitude
                    });
                    queryMECPDistrict(queryPoint);
                  }
                  break;

                default:
                  break;
              }
            } catch (e) {
              // Ignore parsing errors
            }
          });
        });
      </script>
    </body>
  </html>
</apex:page>
