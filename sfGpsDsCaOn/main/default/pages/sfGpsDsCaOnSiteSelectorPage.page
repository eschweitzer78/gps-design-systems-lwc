<apex:page
  lightningStylesheets="true"
  controller="sfGpsDsCaOnSiteSelectorCtr"
  docType="html-5.0"
  showHeader="false"
  sidebar="false"
>
  <!--
    * Copyright (c) 2026, Shannon Schupbach, Jeremy Blankenship and salesforce.com, inc.
    * All rights reserved.
    * Licensed under the BSD 3-Clause license.
    *
    * ESRI Site Selector Map Page
    * Provides address geocoding and site point selection for Ontario Design System.
    * LWR/LWS compatible via postMessage communication.
    -->
  <html>
    <head>
      <meta charset="utf-8" />
      <meta
        name="viewport"
        content="initial-scale=1,maximum-scale=1,user-scalable=no"
      />
      <title>Site Selector Map</title>
      <style>
        html,
        body {
          padding: 0;
          margin: 0;
          height: 100%;
          width: 100%;
        }
        .mapContainer {
          height: 100%;
          width: 100%;
        }
        .loadingIcon {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 100;
        }
      </style>
      <!-- ESRI ArcGIS JavaScript SDK v4.29 loaded from CDN -->
      <link
        rel="stylesheet"
        href="https://js.arcgis.com/4.29/esri/themes/light/main.css"
      />
      <script src="https://js.arcgis.com/4.29/"></script>
    </head>
    <body>
      <div class="loadingIcon" id="loadingIcon">
        <span id="loadingText">Loading map...</span>
      </div>
      <div id="viewDiv" class="mapContainer"></div>

      <script>
        // Configuration from Apex controller
        var apiKey = "{!JSENCODE(apiKey)}";
        var defaultLat = parseFloat("{!JSENCODE(defaultLatitude)}") || 43.6532;
        var defaultLng =
          parseFloat("{!JSENCODE(defaultLongitude)}") || -79.3832;
        var communityUrl = "{!JSENCODE(communityUrl)}";
        var currentMode = "search"; // search, sitepoint, layers
        var currentMarker = null;
        var graphicsLayer = null;
        var view = null;
        var search = null;

        // Initialize ESRI map
        require([
          "esri/config",
          "esri/Map",
          "esri/views/MapView",
          "esri/widgets/ScaleBar",
          "esri/widgets/Search",
          "esri/widgets/Locate",
          "esri/widgets/LayerList",
          "esri/widgets/Expand",
          "esri/Graphic",
          "esri/layers/GraphicsLayer",
          "esri/geometry/Point"
        ], function (
          esriConfig,
          Map,
          MapView,
          ScaleBar,
          Search,
          Locate,
          LayerList,
          Expand,
          Graphic,
          GraphicsLayer,
          Point
        ) {
          // Configure ESRI API key
          if (apiKey) {
            esriConfig.apiKey = apiKey;
          }

          // Create map
          var map = new Map({
            basemap: "topo-vector" // Topographic basemap
          });

          // Create map view
          view = new MapView({
            container: "viewDiv",
            map: map,
            center: [defaultLng, defaultLat],
            zoom: 12,
            constraints: {
              rotationEnabled: false,
              minZoom: 5
            }
          });

          // Graphics layer for markers
          graphicsLayer = new GraphicsLayer();
          map.add(graphicsLayer);

          // Add scale bar
          var scalebar = new ScaleBar({
            view: view,
            unit: "metric"
          });
          view.ui.add(scalebar, "bottom-right");

          // Add Search widget (geocoding)
          search = new Search({
            view: view,
            includeDefaultSources: true,
            popupEnabled: false, // We handle results ourselves
            resultGraphicEnabled: false // We add our own marker
          });
          view.ui.add(search, "top-right");

          // Handle search complete
          search.on("search-complete", function (event) {
            if (
              event.results &&
              event.results.length > 0 &&
              event.results[0].results &&
              event.results[0].results.length > 0
            ) {
              var result = event.results[0].results[0];
              handleSearchResult(result);
            } else {
              sendToLWC({
                name: "searchResult",
                error: "No results found for this address"
              });
            }
          });

          // Add Locate widget
          var locate = new Locate({
            view: view
          });
          view.ui.add(locate, "top-left");

          // Add Layer List in expandable panel
          var layerList = new LayerList({
            view: view
          });
          var layerExpand = new Expand({
            view: view,
            content: layerList,
            expanded: false
          });
          view.ui.add(layerExpand, "top-left");

          // Handle map click for site point mode
          view.on("click", function (event) {
            if (currentMode === "sitepoint") {
              placeMarker(event.mapPoint);
              reverseGeocode(event.mapPoint);
            }
          });

          // Hide loading when view is ready
          view.when(function () {
            document.getElementById("loadingIcon").style.display = "none";
            sendToLWC({ name: "pageLoaded" });
          });

          /**
           * Handles search result and places marker
           */
          function handleSearchResult(result) {
            var feature = result.feature;
            var geometry = feature.geometry;

            // Place marker
            placeMarker(geometry);

            // Parse address from result
            var address = parseAddress(result);

            // Send to LWC
            sendToLWC({
              name: "searchResult",
              address: address,
              coordinates: {
                latitude: geometry.latitude,
                longitude: geometry.longitude
              }
            });

            // Zoom to result
            view.goTo({
              target: geometry,
              zoom: 17
            });
          }

          /**
           * Places a marker on the map
           */
          function placeMarker(point) {
            // Clear existing marker
            graphicsLayer.removeAll();

            // Create marker symbol
            var markerSymbol = {
              type: "simple-marker",
              color: "#cd0000", // Ontario red
              size: "16px",
              outline: {
                color: "#ffffff",
                width: 2
              }
            };

            // Create graphic
            var pointGraphic = new Graphic({
              geometry: point,
              symbol: markerSymbol
            });

            graphicsLayer.add(pointGraphic);
            currentMarker = pointGraphic;
          }

          /**
           * Performs reverse geocoding on a point
           */
          function reverseGeocode(point) {
            // Use ESRI locator for reverse geocoding
            require(["esri/rest/locator"], function (locator) {
              var locatorUrl =
                "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer";

              locator
                .locationToAddress(locatorUrl, {
                  location: point
                })
                .then(function (response) {
                  var address = {
                    streetAddress: response.address || "",
                    city: response.attributes?.City || "",
                    province: response.attributes?.Region || "",
                    postalCode: response.attributes?.Postal || "",
                    country: response.attributes?.CountryCode || "Canada",
                    fullAddress: response.address || ""
                  };

                  sendToLWC({
                    name: "pinPlaced",
                    address: address,
                    coordinates: {
                      latitude: point.latitude,
                      longitude: point.longitude
                    }
                  });
                })
                .catch(function (error) {
                  sendToLWC({
                    name: "error",
                    error: "Could not determine address for this location"
                  });
                });
            });
          }

          /**
           * Parses address from search result
           */
          function parseAddress(result) {
            var attrs = result.feature.attributes || {};
            var name = result.name || "";

            // Try to parse from attributes
            var address = {
              streetAddress:
                attrs.StAddr || attrs.Address || attrs.Match_addr || "",
              city: attrs.City || attrs.PlaceName || "",
              province: attrs.Region || attrs.RegionAbbr || "ON",
              postalCode: attrs.Postal || "",
              country: attrs.Country || attrs.CntryName || "Canada",
              fullAddress: name
            };

            // If no street address, use the full name
            if (!address.streetAddress && name) {
              var parts = name.split(",");
              if (parts.length > 0) {
                address.streetAddress = parts[0].trim();
              }
            }

            return address;
          }

          /**
           * Clears the current marker
           */
          function clearMarker() {
            graphicsLayer.removeAll();
            currentMarker = null;
          }

          /**
           * Handles mode change from LWC
           */
          function setMode(mode) {
            currentMode = mode;

            // Update UI based on mode
            if (mode === "search") {
              search.visible = true;
            } else if (mode === "sitepoint") {
              search.visible = false;
              view.cursor = "crosshair";
            } else if (mode === "layers") {
              search.visible = true;
            }
          }

          /**
           * Sends message to parent LWC
           */
          function sendToLWC(data) {
            if (communityUrl) {
              parent.postMessage(data, communityUrl);
            } else {
              // Fallback for development
              parent.postMessage(data, "*");
            }
          }

          /**
           * Handles messages from parent LWC
           */
          window.addEventListener("message", function (event) {
            // Validate origin if communityUrl is set
            if (communityUrl && event.origin !== communityUrl) {
              return;
            }

            try {
              var msg =
                typeof event.data === "string"
                  ? JSON.parse(event.data)
                  : event.data;

              switch (msg.title) {
                case "search":
                  if (msg.detail && msg.detail.query) {
                    search.search(msg.detail.query);
                  }
                  break;

                case "clearMarker":
                  clearMarker();
                  break;

                case "modeChange":
                  if (msg.detail && msg.detail.mode) {
                    setMode(msg.detail.mode);
                  }
                  break;

                case "goTo":
                  if (
                    msg.detail &&
                    msg.detail.latitude &&
                    msg.detail.longitude
                  ) {
                    var point = new Point({
                      latitude: msg.detail.latitude,
                      longitude: msg.detail.longitude
                    });
                    view
                      .goTo({
                        target: point,
                        zoom: msg.detail.zoom || 17
                      })
                      .then(function () {
                        // Place marker if requested
                        if (msg.detail.placeMarker) {
                          placeMarker(point);
                          reverseGeocode(point);
                        }
                      });
                  }
                  break;

                default:
                  break;
              }
            } catch (e) {
              // Ignore parsing errors
            }
          });
        });
      </script>
    </body>
  </html>
</apex:page>
